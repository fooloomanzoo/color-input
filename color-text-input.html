<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../polymer/lib/utils/mixin.html">
<link rel="import" href="../text-input/text-input.html">
<link rel="import" href="../input-picker-pattern/form-element-mixin.html">
<link rel="import" href="../input-picker-pattern/input-shared-style.html">
<link rel="import" href="color-badge.html">

<script>
  /**
   * Mixin for extending an element to be working with FormElementMixin
   *
   * @mixinFunction
   * @polymer
   */
  const ColorFormMixin = function(superClass) {

    return class extends superClass { // eslint-disable-line no-unused-vars, no-undef

      static get properties() {
        return {
          propertyForValue: {
            type: String,
            value: 'colorString'
          }
        }
      }

      static get observers() {
        return [
          '_computeIsSetFunction(propertyForValue, format)'
        ]
      }

      _computeIsSetFunction(propertyForValue, format) {
        let isSet = this._defaultIsSet;
        this.__updateByColorString = false;
        switch (propertyForValue) {
          case 'colorString':
            let regexp;
            switch (format) {
              case 'hsl':
                regexp = this._validateHsl;
                break;
              case 'rgb':
                regexp = this._validateRgb;
                break;
              case 'hex':
                regexp = this._validateHex;
                break;
              default:
                regexp = this._validateAutoColorString;
            }
            isSet = function(value) {
              return this.__updateByColorString || (typeof value === 'string' && value !== '' && !(regexp.exec(value) === null));
            }
            break;
          case 'r': // falls through
          case 'g': // falls through
          case 'b': // falls through
          case 'h': // falls through
          case 's': // falls through
          case 'l': // falls through
          case 'alpha':
            isSet = function(value, required) {
              return this._defaultIsSet(value) && !isNaN(value);
            }
        }
        this._isSet = isSet.bind(this);
      }

      /**
       * reset the color properties
       */
      reset(value) {
        this.resetColor();
        this._setConfirmedValue();
        if (this._isSet(this.default)) {
          this.value = this.default;
        }
      }
    }
  }
  window.ColorFormMixin = Polymer.dedupingMixin(ColorFormMixin);

  /**
   * Mixin for color-text-input
   *
   * @mixinFunction
   * @polymer
   */
  const ColorTextInputPattern = function(superClass) {

    return class extends superClass { // eslint-disable-line no-unused-vars, no-undef

      static get styleTemplate() {
        return `
          ${super.styleTemplate || ''}
          #input .badge {
            border-radius: var(--input-border-radius, var(--color-badge-radius, 0.2em));
            height: var(--color-badge-height, 100%);
            width: var(--color-badge-width, 1.5em);
            box-shadow: var(--color-badge-shadow, none);
            background-color: rgba(255,255,255,0.75);
          }
          text-input {
            margin-left: 0.25em;
          }
        `;
      }

      static get inputTemplate() {
        return `
          ${this.colorBadgeTemplate}
          ${this.textInputTemplate}
          ${this.resetButtonTemplate}
        `
      }

      static get textInputTemplate() {
        return `
          <text-input required="[[required]]" value="{{colorString}}" auto-resize title="[[title]]" pattern="[[_computeFormatPattern(format, fixedFormat, alphaMode)]]" placeholder="[[_computeFormatPlaceholder(format, alphaMode, _hexAlphaSupported)]]"></text-input>
        `
      }

      static get resetButtonTemplate() {
        return `
          <button class="icon reset" invisible$="[[!valueIsSet]]" hidden$="[[disabled]]" on-click="reset"><svg viewBox="0 0 24 24"><g><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></g></svg></button>
        `
      }

      _computeFormatPattern(format, fixedFormat, alphaMode) {
        switch (format) {
          case 'hsl':
            if (fixedFormat) {
              return this._validateHsl;
            } // falls through
          case 'rgb':
            if (fixedFormat) {
              return this._validateRgb;
            } // falls through
          case 'hex':
            if (fixedFormat && (!alphaMode || this._hexAlphaSupported)) {
              return this._validateHex;
            } // falls through
          default:
            return this._validateAutoColorString;
        }
      }

      _computeFormatPlaceholder(format, alphaMode, hexAlphaSupported) {
        switch (format) {
          case 'hsl':
            return `hsl${alphaMode ? 'a' : ''}(0, 0%, 0%${alphaMode ? ', 1' : ''})`;
          case 'rgb':
            return `rgb${alphaMode ? 'a' : ''}(0, 0, 0${alphaMode ? ', 1' : ''})`;
          default:
            if (!hexAlphaSupported) {
              return `rgb${alphaMode ? 'a' : ''}(0, 0, 0${alphaMode ? ', 1' : ''})`;
            }
            return `#000000`;
        }
      }
    }
  }
  window.ColorTextInputPattern = Polymer.dedupingMixin(ColorTextInputPattern);
</script>

<dom-module id="color-text-input">
  <script>
  /**
  * `<color-text-input>` adds a color input to your page using Polymer.
  * Click on the badge to generate a random color.
  *
  *   ```html
  *     <color-text-input value="{{color}}"></color-text-input>
  *   ```
  *
  *
  * The following custom properties and mixins are also available for styling:
  *
  * Custom property | Description | Default
  * ----------------|-------------|----------
  * `--transparency-pattern` | background pattern for the transparency layer | linear-gradient(45deg, rgba(0,0,0,0.1) 25%, transparent 25%, transparent 75%, rgba(0,0,0,0.1) 75%, rgba(0,0,0,0.1)), linear-gradient(45deg, rgba(0,0,0,0.1) 25%, transparent 25%, transparent 75%, rgba(0,0,0,0.1) 75%, rgba(0,0,0,0.1)))
  * `--transparency-pattern-size` | size transparency pattern | 0.75em
  * `--color-badge-radius` | border-radius of the badge | 0.15em
  * `--color-badge-shadow` | box-shadow of the badge | none
  * `--color-badge-height` | height of the badge | 100%
  * `--color-badge-width` | width of the badge | 1.5em
  *
  * Have a look at [input-picker-pattern#input-shared-style](https://github.com/fooloomanzoo/input-picker-pattern#input-shared-style) to see how to style the element.
  *
  * @customElement
  * @polymer
  *
  * @appliesMixin ColorTextInputPattern
  * @appliesMixin ColorBadgePattern
  * @appliesMixin ColorFormMixin
  * @appliesMixin ColorMixin
  * @appliesMixin FormElementMixin
  *
  * @demo demo/input.html
  * @demo demo/form.html in a form
  **/
    class ColorTextInput extends ColorTextInputPattern(ColorBadgePattern(ColorFormMixin(ColorMixin(FormElementMixin(Polymer.Element))))) { // eslint-disable-line no-undef

      static get is() {
        return 'color-text-input';
      }

      static get template() {
        return `
          <style include="${this.styleToInclude}">
            ${this.styleTemplate}
          </style>
          <div id="input">
            ${this.inputTemplate}
          </div>
        `;
      }
    }
    window.customElements.define(ColorTextInput.is, ColorTextInput);
  </script>
</dom-module>
